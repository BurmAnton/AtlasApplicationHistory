{% extends 'history/base.html' %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

<style>
    .select2-container .select2-selection--single {
        height: 38px !important; 
    }
    /* Tooltip scrollable area */
    .tooltip-history-scroll {
        max-height: 300px;
        overflow-y: auto;
        padding-right: 5px;
    }
    /* Custom Scrollbar for tooltip */
    .tooltip-history-scroll::-webkit-scrollbar {
        width: 6px;
    }
    .tooltip-history-scroll::-webkit-scrollbar-track {
        background: #333;
    }
    .tooltip-history-scroll::-webkit-scrollbar-thumb {
        background: #666;
        border-radius: 3px;
    }
    .tooltip-history-scroll::-webkit-scrollbar-thumb:hover {
        background: #888;
    }
    .stats-card {
        font-size: 0.85rem;
    }
    .stats-list {
        max-height: 150px;
        overflow-y: auto;
    }
</style>

<!-- Import Section (Collapsible) -->
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#importCollapse">
        <div class="d-flex align-items-center">
            <h5 class="mb-0 me-3">Импорт данных</h5>
            {% if last_import %}
            <small class="text-muted">
                Последний импорт: <strong>{{ last_import.filename }}</strong> 
                (срез: {{ last_import.snapshot_dt|date:"d.m.Y H:i" }})
            </small>
            {% endif %}
        </div>
        <div>
            {% if import_history %}
            <button type="button" class="btn btn-sm btn-outline-info me-2" data-bs-toggle="modal" data-bs-target="#historyModal" onclick="event.stopPropagation();">
                История загрузок
            </button>
            {% endif %}
            <i class="bi bi-chevron-down"></i>
        </div>
    </div>
    <div class="collapse show" id="importCollapse">
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" class="row">
                {% csrf_token %}
                <input type="hidden" name="upload_file" value="true">
                
                {% for field in import_form %}
                    <div class="col-md-5 mb-3">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.help_text %}
                            <div class="form-text small">{{ field.help_text }}</div>
                        {% endif %}
                        {% if field.errors %}
                            <div class="text-danger small">{{ field.errors }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
                <div class="col-md-2 mb-3">
                    <label class="form-label d-block">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">Загрузить</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="historyModalLabel">История загрузок</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Файл</th>
                                <th>Дата среза</th>
                                <th>Дата загрузки</th>
                                <th>Создано</th>
                                <th>Обновлено</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in import_history %}
                            <tr>
                                <td>{{ item.filename }}</td>
                                <td>{{ item.snapshot_dt|date:"d.m.Y H:i" }}</td>
                                <td>{{ item.upload_dt|date:"d.m.Y H:i" }}</td>
                                <td>{{ item.created_count }}</td>
                                <td>{{ item.updated_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<!-- Statistics Section (Collapsible) -->
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#statsCollapse">
        <h5 class="mb-0">Статистика (по текущему фильтру)</h5>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="collapse" id="statsCollapse">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-striped table-bordered mb-0">
                    <thead class="table-light">
                        <tr>
                            <th colspan="2" class="text-center border-end">Атлас (Текущий)</th>
                            <th colspan="2" class="text-center border-end">Атлас (Предыдущий)</th>
                            <th colspan="2" class="text-center border-end">РР (Текущий)</th>
                            <th colspan="2" class="text-center">РР (Предыдущий)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in stats_rows %}
                        <tr>
                            <!-- Atlas Current -->
                            <td>{% if row.0 %}{{ row.0.current_atlas_status|default:"-" }}{% endif %}</td>
                            <td class="text-end fw-bold border-end" style="width: 50px;">{% if row.0 %}{{ row.0.total }}{% endif %}</td>
                            
                            <!-- Atlas Previous -->
                            <td>{% if row.1 %}{{ row.1.prev_atlas_status|default:"-" }}{% endif %}</td>
                            <td class="text-end fw-bold border-end" style="width: 50px;">{% if row.1 %}{{ row.1.total }}{% endif %}</td>
                            
                            <!-- RR Current -->
                            <td>{% if row.2 %}{{ row.2.current_rr_status|default:"-" }}{% endif %}</td>
                            <td class="text-end fw-bold border-end" style="width: 50px;">{% if row.2 %}{{ row.2.total }}{% endif %}</td>
                            
                            <!-- RR Previous -->
                            <td>{% if row.3 %}{{ row.3.prev_rr_status|default:"-" }}{% endif %}</td>
                            <td class="text-end fw-bold" style="width: 50px;">{% if row.3 %}{{ row.3.total }}{% endif %}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">Фильтры</h5>
        <form method="get">
            <!-- Search Row -->
            <div class="row mb-3">
                 <div class="col-md-12">
                    <label class="form-label small text-muted mb-1">Поиск</label>
                    <div class="input-group">
                        <input type="text" name="search" class="form-control" placeholder="Поиск по ФИО, Email, ID..." value="{{ search_query }}">
                        <button class="btn btn-primary" type="submit">Найти</button>
                    </div>
                </div>
            </div>

            <!-- Filters Row (row 1) -->
            <div class="row g-3">
                <div class="col-lg-3 col-md-6">
                     <label class="form-label small text-muted mb-1">Программа</label>
                    <select name="program" class="form-select select2">
                        <option value="">Все программы</option>
                        {% for prog in programs %}
                        <option value="{{ prog }}" {% if program_filter == prog %}selected{% endif %}>{{ prog }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-lg-3 col-md-6">
                    <label class="form-label small text-muted mb-1">Статус Атлас (Тек)</label>
                    <select name="status_atlas" class="form-select select2">
                        <option value="">Все</option>
                        {% for stat in statuses_atlas %}
                            {% if stat %}
                            <option value="{{ stat }}" {% if status_atlas_filter == stat %}selected{% endif %}>{{ stat }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="col-lg-3 col-md-6">
                    <label class="form-label small text-muted mb-1">Статус РР (Тек)</label>
                    <select name="status_rr" class="form-select select2">
                        <option value="">Все</option>
                        {% for stat in statuses_rr %}
                            {% if stat %}
                            <option value="{{ stat }}" {% if status_rr_filter == stat %}selected{% endif %}>{{ stat }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>

                <div class="col-lg-3 col-md-6">
                    <label class="form-label small text-muted mb-1">Дата среза</label>
                    <select name="date" class="form-select">
                        <option value="" {% if not selected_date %}selected{% endif %}>Все даты</option>
                        {% for dt in snapshot_points %}
                            {% with dt_str=dt|date:"Y-m-d\\TH:i:s" %}
                                <option value="{{ dt_str }}" {% if selected_date == dt_str %}selected{% endif %}>
                                    {{ dt|date:"d.m.Y H:i" }}
                                </option>
                            {% endwith %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            
             <!-- Second Row of Filters (Dates and Previous Statuses) -->
             <div class="row g-3 mt-1">
                 <div class="col-lg-3 col-md-6">
                     <label class="form-label small text-muted mb-1">Начало обучения</label>
                     <input type="date" name="start_date" class="form-control" value="{{ start_date_filter }}">
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label small text-muted mb-1">Окончание</label>
                    <input type="date" name="end_date" class="form-control" value="{{ end_date_filter }}">
                </div>

                <div class="col-lg-3 col-md-6">
                    <label class="form-label small text-muted mb-1">Статус Атлас (Пред)</label>
                    <select name="prev_status_atlas" class="form-select select2">
                        <option value="">Все</option>
                        {% for stat in prev_statuses_atlas %}
                            {% if stat %}
                            <option value="{{ stat }}" {% if prev_status_atlas_filter == stat %}selected{% endif %}>{{ stat }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                 <div class="col-lg-3 col-md-6">
                    <label class="form-label small text-muted mb-1">Статус РР (Пред)</label>
                    <select name="prev_status_rr" class="form-select select2">
                        <option value="">Все</option>
                        {% for stat in prev_statuses_rr %}
                            {% if stat %}
                            <option value="{{ stat }}" {% if prev_status_rr_filter == stat %}selected{% endif %}>{{ stat }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Buttons Row -->
            <div class="row g-3 mt-2">
                <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="submit" class="btn btn-secondary btn-sm">Применить фильтры</button>
                    <button type="submit" name="reset" value="1" class="btn btn-outline-secondary btn-sm">Сброс</button>
                    <button type="submit" name="export" value="true" class="btn btn-success btn-sm">Excel</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>РР ID</th>
                <th>ФИО</th>
                <th>Программа</th>
                <th>Регион</th>
                <th>Статус Атлас</th>
                <th>Статус РР</th>
                <th>Даты</th>
            </tr>
        </thead>
        <tbody>
            {% for app in page_obj %}
            <tr data-bs-toggle="tooltip" data-bs-html="true" title="
                <div class='fw-bold mb-2'>История изменений:</div>
                <div class='tooltip-history-scroll'>
                {% for h in app.history.all %}
                    <div class='status-history-item'>
                        <small>{{ h.snapshot_dt|date:'d.m.Y H:i' }}</small><br>
                        А: {{ h.atlas_status }} | РР: {{ h.rr_status }}
                    </div>
                {% endfor %}
                </div>
            ">
                <td>
                    {{ app.rr_id }}
                    {% if app.request_date %}
                    <br><small class="text-muted" title="Дата подачи заявки на РР">{{ app.request_date|date:"d.m.Y" }}</small>
                    {% endif %}
                </td>
                <td>
                    {{ app.last_name|default:"" }} {{ app.first_name|default:"" }} {{ app.middle_name|default:"" }}
                    <br><small class="text-muted">{{ app.email }}</small>
                </td>
                <td>
                    {{ app.program_name|truncatechars:50 }}
                    <br><small class="text-muted">ID: {{ app.program_id }}</small>
                </td>
                <td>{{ app.region }}</td>
                
                <td>
                    {% if selected_date %}
                        {{ app.hist_atlas_status }}
                    {% else %}
                        {% if app.prev_atlas_status and app.prev_atlas_status != app.current_atlas_status %}
                            <span class="text-muted">{{ app.prev_atlas_status }}</span> ➡️ 
                        {% endif %}
                        <strong>{{ app.current_atlas_status }}</strong>
                    {% endif %}
                </td>
                
                <td>
                    {% if selected_date %}
                        {{ app.hist_rr_status }}
                    {% else %}
                        {% if app.prev_rr_status and app.prev_rr_status != app.current_rr_status %}
                            <span class="text-muted">{{ app.prev_rr_status }}</span> ➡️ 
                        {% endif %}
                        <strong>{{ app.current_rr_status }}</strong>
                    {% endif %}
                </td>

                <td>
                    <small>
                    {{ app.start_date|date:"d.m.Y" }} - {{ app.end_date|date:"d.m.Y" }}
                    </small>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center">Нет данных</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1&search={{ search_query }}&program={{ program_filter }}&status_atlas={{ status_atlas_filter }}&status_rr={{ status_rr_filter }}&prev_status_atlas={{ prev_status_atlas_filter }}&prev_status_rr={{ prev_status_rr_filter }}&start_date={{ start_date_filter }}&end_date={{ end_date_filter }}&date={{ selected_date }}">Первая</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&program={{ program_filter }}&status_atlas={{ status_atlas_filter }}&status_rr={{ status_rr_filter }}&prev_status_atlas={{ prev_status_atlas_filter }}&prev_status_rr={{ prev_status_rr_filter }}&start_date={{ start_date_filter }}&end_date={{ end_date_filter }}&date={{ selected_date }}">Назад</a></li>
        {% endif %}

        <li class="page-item disabled"><a class="page-link" href="#">Стр. {{ page_obj.number }} из {{ page_obj.paginator.num_pages }}</a></li>

        {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&program={{ program_filter }}&status_atlas={{ status_atlas_filter }}&status_rr={{ status_rr_filter }}&prev_status_atlas={{ prev_status_atlas_filter }}&prev_status_rr={{ prev_status_rr_filter }}&start_date={{ start_date_filter }}&end_date={{ end_date_filter }}&date={{ selected_date }}">Вперед</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&search={{ search_query }}&program={{ program_filter }}&status_atlas={{ status_atlas_filter }}&status_rr={{ status_rr_filter }}&prev_status_atlas={{ prev_status_atlas_filter }}&prev_status_rr={{ prev_status_rr_filter }}&start_date={{ start_date_filter }}&end_date={{ end_date_filter }}&date={{ selected_date }}">Последняя</a></li>
        {% endif %}
    </ul>
</nav>

<!-- Select2 JS -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    $(document).ready(function() {
        $('.select2').select2({
            theme: 'bootstrap-5',
            width: '100%',
            placeholder: "Выбрать...",
            allowClear: true,
            dropdownAutoWidth: true
        });
    });
</script>
{% endblock %}
